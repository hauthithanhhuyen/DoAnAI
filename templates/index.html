<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Nh·∫≠n Di·ªán C·∫£m X√∫c</title>
    <style>
        /* CSS CHO ƒêI·ªÜN THO·∫†I V√Ä M√ÅY T√çNH */
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: #f0f2f5; margin: 0; padding: 10px; }
        
        .container { 
            width: 100%; 
            max-width: 800px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            padding: 15px; 
            box-sizing: border-box; 
        }

        h1 { color: #1a73e8; font-size: 24px; margin-bottom: 15px; }
        
        .user-input-group { margin-bottom: 15px; }
        .user-input-group input { 
            padding: 12px; width: 100%; max-width: 300px; 
            border: 2px solid #ddd; border-radius: 6px; 
            font-size: 16px; outline: none; box-sizing: border-box;
        }

        /* KHUNG CAMERA RESPONSIVE */
        .display-area { 
            position: relative; width: 100%; height: 0;
            padding-bottom: 75%; /* T·ªâ l·ªá 4:3 */
            background: #000; border-radius: 10px; 
            overflow: hidden; margin-bottom: 15px;
        }
        
        video, canvas { 
            position: absolute; top: 0; left: 0; 
            width: 100%; height: 100%; object-fit: cover; 
        }
        
        .mirror-video { transform: scaleX(-1); }

        .controls { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        .btn { 
            padding: 12px 15px; font-size: 14px; cursor: pointer; 
            color: white; border: none; border-radius: 6px; 
            font-weight: bold; flex: 1 1 auto; min-width: 100px;
        }
        .btn-cam { background: #4CAF50; }
        .btn-upload { background: #2196F3; }
        .btn-stop { background: #f44336; }
        .btn-link { background: #607D8B; text-decoration: none; display: flex; align-items: center; justify-content: center;}
        
        #result-text { font-size: 18px; font-weight: bold; color: #333; margin-top: 10px; min-height: 25px;}
    </style>
</head>
<body>

<div class="container">
    <h1>ü§ñ AI C·∫£m X√∫c (B·∫£n Fix Nh·∫π)</h1>

    <div class="user-input-group">
        <input type="text" id="username" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n..." required>
    </div>

    <div class="display-area">
        <video id="video" autoplay playsinline class="mirror-video"></video>
        <canvas id="canvas"></canvas>
    </div>

    <div id="result-text">Vui l√≤ng nh·∫≠p t√™n</div>

    <div class="controls">
        <button class="btn btn-cam" onclick="startCamera()">üì∏ B·∫≠t Cam</button>
        <button class="btn btn-stop" onclick="stopCamera()">üõë T·∫Øt</button>
        <label for="fileInput" class="btn btn-upload">üìÇ T·∫£i ·∫¢nh</label>
        <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="handleUpload()">
        <a href="/history" target="_blank" class="btn btn-link">üìú L·ªãch S·ª≠</a>
    </div>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const resultText = document.getElementById('result-text');
    const nameInput = document.getElementById('username');
    let intervalId = null;
    let isCameraMode = true;

    function resizeCanvas() {
        canvas.width = video.videoWidth || 640;
        canvas.height = video.videoHeight || 480;
    }

    function checkName() {
        const name = nameInput.value.trim();
        if (!name) {
            alert("B·∫°n ch∆∞a nh·∫≠p t√™n k√¨a!");
            nameInput.focus();
            return false;
        }
        return name;
    }

    async function startCamera() {
        if (!checkName()) return;
        stopCamera();
        isCameraMode = true;
        video.style.display = "block";
        
        try {
            const constraints = { video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } } };
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;
            
            video.onloadedmetadata = () => { resizeCanvas(); };
            resultText.innerText = "ƒêang k·∫øt n·ªëi Server...";
            // TƒÉng th·ªùi gian g·ª≠i l√™n 1000ms (1 gi√¢y) ƒë·ªÉ gi·∫£m t·∫£i cho Server
            intervalId = setInterval(sendFrameToServer, 1000);
        } catch (err) { 
            alert("L·ªói Camera (H√£y d√πng HTTPS): " + err); 
        }
    }

    function stopCamera() {
        if (intervalId) clearInterval(intervalId);
        if (video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
            video.srcObject = null;
        }
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        resultText.innerText = "ƒê√£ d·ª´ng";
    }

    // --- H√ÄM QUAN TR·ªåNG ƒê√É ƒê∆Ø·ª¢C S·ª¨A ---
    function sendFrameToServer() {
        if (!isCameraMode) return;
        if (canvas.width !== video.videoWidth) resizeCanvas();

        // T·∫†O CANVAS PH·ª§ ƒê·ªÇ THU NH·ªé ·∫¢NH
        const tempCanvas = document.createElement('canvas');
        // √âp ·∫£nh xu·ªëng c√≤n chi·ªÅu r·ªông 200px (R·∫•t nh·∫π)
        const targetWidth = 200; 
        const scale = targetWidth / video.videoWidth;
        const targetHeight = video.videoHeight * scale;

        tempCanvas.width = targetWidth;
        tempCanvas.height = targetHeight;

        // V·∫Ω ·∫£nh nh·ªè l√™n tempCanvas
        tempCanvas.getContext('2d').drawImage(video, 0, 0, tempCanvas.width, tempCanvas.height);
        
        // G·ª≠i ·∫£nh nh·ªè ƒëi
        fetch('/process_frame', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                image: tempCanvas.toDataURL('image/jpeg', 0.5), // Gi·∫£m ch·∫•t l∆∞·ª£ng xu·ªëng 0.5
                username: nameInput.value 
            })
        })
        .then(res => res.json())
        .then(data => {
            // Khi nh·∫≠n ƒë∆∞·ª£c t·ªça ƒë·ªô, ta ph·∫£i ph√≥ng to n√≥ l√™n l·∫°i ƒë·ªÉ v·∫Ω v·ª´a m√†n h√¨nh
            if(data.box){
                // Server tr·∫£ v·ªÅ t·ªça ƒë·ªô c·ªßa ·∫£nh 200px, ta ph·∫£i nh√¢n ng∆∞·ª£c l√™n
                const scaleBack = video.videoWidth / 200;
                data.box = data.box.map(x => x * scaleBack);
            }
            drawResult(data);
        })
        .catch(err => {
            console.log("L·ªói g·ª≠i ·∫£nh (C√≥ th·ªÉ do m·∫°ng ho·∫∑c Server busy):", err);
        });
    }

    function handleUpload() {
        if (!checkName()) return;
        const file = document.getElementById('fileInput').files[0];
        if (!file) return;

        stopCamera();
        isCameraMode = false;
        video.style.display = "none";

        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                canvas.width = img.width; canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                uploadToServer(file);
            }
            img.src = e.target.result;
        }
        reader.readAsDataURL(file);
    }

    function uploadToServer(file) {
        resultText.innerText = "ƒêang x·ª≠ l√Ω...";
        const formData = new FormData();
        formData.append('file', file);
        formData.append('username', nameInput.value);

        fetch('/upload', { method: 'POST', body: formData })
        .then(res => res.json()).then(data => drawResult(data))
        .catch(err => alert("L·ªói t·∫£i ·∫£nh: " + err));
    }

    function drawResult(data) {
        if (isCameraMode) ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (data.has_face) {
            let [x, y, w, h] = data.box;
            
            // X·ª≠ l√Ω l·∫≠t g∆∞∆°ng n·∫øu ƒëang d√πng cam tr∆∞·ªõc
            if (isCameraMode) {
                // T·ªça ƒë·ªô x c·∫ßn l·∫≠t ng∆∞·ª£c l·∫°i
                x = canvas.width - x - w;
            }

            ctx.beginPath();
            ctx.lineWidth = 4;
            ctx.strokeStyle = "#00FF00";
            ctx.rect(x, y, w, h);
            ctx.stroke();

            ctx.font = "bold 24px Arial";
            ctx.fillStyle = "#00FF00";
            // V·∫Ω ch·ªØ l√™n tr√™n khung
            ctx.fillText(data.emotion, x, y > 30 ? y - 10 : y + h + 30);
            
            resultText.innerText = `${nameInput.value}: ${data.emotion}`;
            resultText.style.color = "green";
        } else {
            // N·∫øu kh√¥ng th·∫•y m·∫∑t th√¨ th√¥i, kh√¥ng c·∫ßn b√°o ƒë·ªè li√™n t·ª•c g√¢y kh√≥ ch·ªãu
            if(!isCameraMode) {
                 resultText.innerText = "Kh√¥ng th·∫•y m·∫∑t";
                 resultText.style.color = "red";
            }
        }
    }
</script>

</body>
</html>
